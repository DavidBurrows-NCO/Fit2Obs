set -eua

ptmp=/gpfs/hps/ptmp/$USER; mkdir -p $ptmp

EXPNAM=$1 CDATE=$2 COMROT=${3:-$ptmp/$USER} ARCDIR=${4:-$COMROT/archive} TMPDIR=${5:-$ptmp/$USER/tmpdir}

ACCOUNT=${ACCOUNT:-CFS-T2O}
CUE2RUN=${CUE2RUN:-dev}

echo -------------------------------------------------------------------------------------------------------------------
echo Starting the runfits for:
echo -------------------------------------------------------------------------------------------------------------------
echo "EXPNAM    " $EXPNAM       # argument 1 - experiment name    - required  (can be prod in which case COMROT is moot)
echo "CDATE     " $CDATE        # argument 2 - date of validation - required 
echo "COMROT    " $COMROT       # argument 3 - COMROT directory   - optional - defaults to /ptmp/$USER
echo "ARCDIR    " $ARCDIR       # argument 4 - ARCDIR directory   - optional - defaults to $COMROT/archive 
echo "TMPDIR    " $TMPDIR       # argument 5 - TMPDIR directory   - optional - defaults to /ptmp/$USER/tmpdir
echo "ACCOUNT   " $ACCOUNT      # inheirited - project code       - required - defaults to nothing  
echo -------------------------------------------------------------------------------------------------------------------

fitdir=$(dirname $0); fitdir=$(cd $fitdir; pwd)
COMDAY=${COMDAY:-$COMROT}

set -euax          

cat<<EOF|bsub 
#!/bin/sh --login
#BSUB -L /bin/sh
#BSUB -o $COMDAY/FITS.$EXPNAM.$CDATE.dayfile
#BSUB -J FITS.$EXPNAM.$CDATE
#BSUB -P $ACCOUNT       
#BSUB -extsched 'CRAYLINUX[]' -R '1*{select[craylinux && !vnode] rusage[mem=1800] } + 72*{select[craylinux && vnode]span[ptile=24] cu[type=cabinet]}'
#BSUB -W ${TIMELIM:-02:00}
#BSUB -q $CUE2RUN
#BSUB -x               

export OMP_NUM_THREADS=1  
export KMP_AFFINITY=disabled
export MPIRUN="aprun -j1 -n3 -N1 -d\$OMP_NUM_THREADS"

export fitdir=$fitdir
export ARCDIR=$ARCDIR
export TMPDIR=$TMPDIR
export ACPROFit=${ACPROFit:-NO}
export NEMS=${NEMS:-NO}   

time $fitdir/runfits $EXPNAM $CDATE $COMROT

EOF
