#!/bin/bash
set -eua

EXPNAM=${EXPNAM:-pr$PSLOT}
CDUMPPREP=${CDUMPPREP:-gdas}
CDUMPFCST=${CDUMPFCST:-gfs}

echo Starting the runfits for:
echo CDATE'       '$CDATE
echo EXP'         '$PSLOT        
echo COMROT'      '$COMROT
echo COMDAY'      '$COMDAY
echo ARCDIR'      '$ARCDIR
echo TMPDIR'      '$TMPDIR
echo EXPNAM'      '$EXPNAM
echo ACCOUNT'     '$ACCOUNT
echo CDUMPPREP'   '$CDUMPPREP
echo CDUMPFCST'   '$CDUMPFCST

set -x

fitdir=${fitdir:-$(dirname $0)}

cat<<eof | qsub
#PBS -S /bin/ksh
#PBS -A $ACCOUNT
#PBS -N FITS.$EXPNAM.$CDATE
#PBS -o $COMDAY/FITS.$EXPNAM.$CDATE.dayfile      
#PBS -q ${FITCUE:-batch}  
#PBS -l ${FITPPN:-"nodes=3:ppn=1"}   
#PBS -l walltime=${FITTIM:-"01:00:00"} 
#PBS -d `pwd`
#PBS -j oe
#PBS -V

set -euax

KMP_STACKSIZE=100M
MPI_BUFS_PER_PROC=256
MPI_BUFS_PER_HOST=256
MPI_GROUP_MAX=256
OMP_NUM_THREADS=${FITOMP:-23}
MPIRUN='mpirun'
ulimit -s 20000000; ulimit -a

time $fitdir/runfits $EXPNAM $CDATE $COMROT

eof

